{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reports</title>
  <link rel="stylesheet" href="{% static 'reports.css' %}" />
 
</head>
<body>
   <div class="topbar">
    <div class="topbar-brand">Reports</div>
    <nav class="topbar-nav">
        <a href="{% url 'overview' %}">Overview</a>
        <div class="topbar-dropdown-container">
        <a href="{% url 'dashboard' %}" class="topbar-dropdown-toggle">
            Tickets <span class="dropdown-arrow">â–¼</span>
        </a>
        <div class="topbar-dropdown-menu">
            <a href="{% url 'caller_details' %}" id="caller-details-link" class="dropdown-item">Caller Details</a>
        </div>
        </div>
        {% if request.session.role == 'admin' %}
            <a href="{% url 'user_management' %}">User Management</a>
            <a href="{% url 'master_data' %}">Master Data</a>
        {% endif %}
        <a href="{% url 'reports' %}" class="active">Reports</a>
    </nav>
    <div class="topbar-user">
        <span>Welcome, {{ request.session.name|default:request.session.username }}</span>
    <div class="profile-dropdown">
        <button class="profile-btn" title="User Menu">
            <svg class="profile-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </button>
        <div class="profile-menu">
            <a href="{% url 'reset' %}" class="profile-menu-item">Reset Password</a>
            <a href="{% url 'logout' %}" class="profile-menu-item">Logout</a>
        </div>
    </div>
</div>
</div>


<div class="reports-header">
    <div class="reports-header-top">
        <div class="reports-header-text">
            <h1 class="reports-title">Reports & Analytics</h1>
            <p class="reports-subtitle">Key reports and insights for support tasks</p>
        </div>

        <!-- Generate PDF & Export Data - Top Right -->
        <div class="reports-actions">
            <button class="btn btn-outline">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 10v6m-3-3h6m6 6H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2z"/>
                </svg>
                Generate PDF
            </button>
            <button class="btn btn-primary">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                    <polyline points="16 6 12 2 8 6"/>
                    <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
                Export Data
            </button>
        </div>
    </div>

    <!-- Filters Row - Full width, below title -->
    <!-- <div class="reports-filters">
        <div class="filter-dropdown">
            <div class="filter-select-wrapper">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"/>
                </svg>

                <select id="school-select" name="school" class="filter-select">
                <option value="">All Schools</option>
                {% for s in schools %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
                </select>

                <svg class="dropdown-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>



        <div class="filter-dropdown">
            <div class="filter-date-wrapper" id="date-wrapper">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 8h18M8 4v4M16 4v4M5 8v12h14V8"/>
                </svg>

                <span id="date-display" class="date-display">Select date</span>

                <svg class="dropdown-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 9l-7 7-7-7"/>
                </svg>

                <input type="date" id="date-input" class="date-input-hidden">
            </div>
        </div>

    </div> -->
</div>
 
<!-- ====================== MAIN CONTENT - REPORTS DASHBOARD ====================== -->

    <div class="dashboard-grid">

    <div class="report-card">
    <h2 class="report-card-title">Category Classification</h2>
    <p>Issue distribution by category type</p>

    <div class="chart-container">
        <canvas id="ticketCategoryChart"></canvas>

        <div class="chart-legend">
            {% for label, count in category_legend %}
                <div class="legend-item">
                <!-- <span class="dot"></span>{{ label }}  -->
                <span class="dot dot-{{ forloop.counter0 }}"></span>{{ label }}
                <span class="count">{{ count }}</span>
                </div>
            {% endfor %}
        
        </div>
    </div>
    </div>

    <div class="platform-card">
    <div>
        <h2 class="title">Platform Distribution</h2>
        <p class="subtitle">Tickets by platform source</p>
    </div>

    <div class="platform-content">
        <!-- Donut on the left -->
        <div class="donut-wrapper">
            <div class="donut" id="platform-donut"></div>
            <div class="donut-center-text">
                <div class="center-count" id="center-count-value">560</div>
                <div class="center-label">{{ total_tickets }}</div>
            </div>
        </div>

        <!-- List on the right -->
        <div class="platform-list">
            <div class="platform-item" data-segment="web">
                <div class="platform-left">
                    <div class="platform-icon web"><div class="icon-desktop"></div></div>
                    <div>
                        <div class="platform-text-main">Web</div>
                        <div class="platform-text-sub">Application</div>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="platform-count">{{ web_count }}</div>
                    <div class="platform-progress"><div class="platform-progress-bar web"></div></div>
                   
                </div>
            </div>

            <div class="platform-item" data-segment="mobile">
                <div class="platform-left">
                    <div class="platform-icon mobile"><div class="icon-mobile"></div></div>
                    <div>
                        <div class="platform-text-main">Mobile</div>
                        <div class="platform-text-sub">Application</div>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="platform-count">{{ mobile_count }}</div>
                    <div class="platform-progress"><div class="platform-progress-bar mobile"></div></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

 
<script>
  const dateWrapper = document.getElementById('date-wrapper');
  const dateInput = document.getElementById('date-input');
  const dateDisplay = document.getElementById('date-display');

  dateWrapper.addEventListener('click', function () {
    if (dateInput.showPicker) {
      dateInput.showPicker();   // modern browsers
    } else {
      dateInput.focus();
    }
  });

  dateInput.addEventListener('change', function () {
    if (!this.value) {
      dateDisplay.textContent = 'Select date';
      return;
    }
    const d = new Date(this.value);
    const day = String(d.getDate()).padStart(2, '0');
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const month = monthNames[d.getMonth()];
    const year = d.getFullYear();
    dateDisplay.textContent = `${day} ${month} ${year}`;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctx = document.getElementById('ticketCategoryChart').getContext('2d');

// values from Django context (already JSON)
const categoryLabels = JSON.parse('{{ category_labels|escapejs }}');
const categoryData   = JSON.parse('{{ category_data|escapejs }}');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: categoryLabels,
        datasets: [{
            data: categoryData,
            backgroundColor: ['#e74c3c','#f39c12','#16a085',
                              '#3498db','#8e44ad','#1abc9c'],
            borderRadius: 6
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
        },
        responsive: false
    }
});
</script>

<script>
        // Data configuration
        const DATA = {
            web: { label: "Web", count: 342, percent: 61.1 },
            mobile: { label: "Mobile", count: 218, percent: 38.9 }
        };

        const donut = document.getElementById("platform-donut");
        const items = document.querySelectorAll(".platform-item");
        const centerText = document.getElementById("donut-center-text");
     

        // 1. Animate donut on page load (already mostly working)
        window.addEventListener("load", () => {
            // Add the 'animate' class to trigger the CSS animation
            donut.classList.add("animate");
            
            // For persistence, we add 'final' class after the animation finishes
            setTimeout(() => {
                donut.classList.add("final");
                donut.classList.remove("animate");
            }, 1200); // Match animation duration
        });

        // 2. Hover behavior for each platform row (simulates chart hover for better UX)
        items.forEach((item) => {
            const key = item.dataset.segment;
            const info = DATA[key];

            // Mouse Enter (Hover In)
            item.addEventListener("mouseenter", () => {
                // Display text in the center of the donut
                centerCountValue.textContent = info.count;
                centerLabelValue.textContent = `${info.label} Tickets`;
                centerText.classList.add("visible");
            });

            // Mouse Leave (Hover Out)
            item.addEventListener("mouseleave", () => {
                // Hide text from the center of the donut
                centerText.classList.remove("visible");
            });

            // For accessibility: Focus/Blur
            item.addEventListener("focus", () => {
                centerCountValue.textContent = info.count;
                centerLabelValue.textContent = `${info.label} Tickets`;
                centerText.classList.add("visible");
            });
            item.addEventListener("blur", () => {
                centerText.classList.remove("visible");
            });
        });
        
        // Remove the old click functionality
        // items.forEach((item) => { item.addEventListener("click", () => { ... }) });
    </script>


<script>
// Hover: show real platform count, default = total
const centerCount = document.getElementById("center-count-value");
const centerLabel = document.querySelector(".donut-center-text .center-label");
const totalTickets = "{{ total_tickets }}";

window.addEventListener("load", () => {
    centerCount.textContent = totalTickets;
    centerLabel.textContent = "Total Tickets";
});

document.querySelectorAll(".platform-item").forEach(item => {
    const count = item.querySelector(".platform-count").textContent.trim();
    const name  = item.querySelector(".platform-text-main").textContent.trim();

    item.addEventListener("mouseenter", () => {
        centerCount.textContent = count;
        centerLabel.textContent = name + " Tickets";
    });

    item.addEventListener("mouseleave", () => {
        centerCount.textContent = totalTickets;
        centerLabel.textContent = "Total Tickets";
    });
});
</script>

</body>
</html>
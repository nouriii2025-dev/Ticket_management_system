{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Incidents Table</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'dashboard.css' %}">
</head>
<body>  
<span id="currentUsername" style="display:none;">{{ current_username }}</span>
<span id="currentUserFullName" style="display:none;">{{ current_user_fullname }}</span>

<div class="topbar">
    <div class="topbar-brand">Ticket Management</div>
    <nav class="topbar-nav">
        <a href="{% url 'overview' %}">Overview</a>
        <!-- <a href="{% url 'dashboard' %}" class="active">Tickets</a> -->
      
        <div class="topbar-dropdown-container">
        <a href="{% url 'dashboard' %}" class="active topbar-dropdown-toggle">
            Tickets <span class="dropdown-arrow">▼</span>
        </a>
        <div class="topbar-dropdown-menu">
            <a href="{% url 'caller_details' %}" id="caller-details-link" class="dropdown-item">Caller Details</a>

        </div>
    </div>

        {% if request.session.role == 'admin' %}
            <a href="{% url 'user_management' %}">User Management</a>
            <a href="{% url 'master_data' %}">Master Data</a>
            <a href="{% url 'reports' %}">Reports</a>
        {% endif %}
    </nav>
 
    <div class="topbar-user">
        <span>Welcome, {{ request.session.name|default:request.session.username }}</span>
    <div class="profile-dropdown">
        <button class="profile-btn" title="User Menu">
            <svg class="profile-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <!-- <span class="user-initials">{{ request.session.name|default:request.session.username|slice:":1"|upper }}</span> -->
        </button>
        <div class="profile-menu">
            <a href="{% url 'reset' %}" class="profile-menu-item">Reset Password</a>
            <a href="{% url 'logout' %}" class="profile-menu-item">Logout</a>
        </div>
    </div>
</div>

</div>
    <div class="main-content">
      <div class="content-area">    
            {% if messages %}
            {% for message in messages %}
              <div style="background-color:#aef3ae; color:#077f17; padding:10px; border-radius:5px; margin-bottom:10px; font-weight:500;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        <form method="POST" action="{% url 'delete_tickets' %}" onsubmit="return confirm('Are you sure you want to delete the selected tickets?');">
        {% csrf_token %}
        <div class="search-and-table-container">
          <header class="header">
            {% if request.session.role == 'admin' %}
            <button type="submit" class="delete-ticket-btn">Delete</button>
            {% endif %}
            <a href="{% url 'create' %}"><button type="button" class="add-ticket-btn">+ Add Ticket</button></a>
           
          </header>
          <fieldset class="page-title-fieldset">
       
          <legend>Tickets</legend>

<div class="ticket-toolbar-modern">
    <div class="toolbar-controls">
        <label class="select-all-label">
            <input type="checkbox" id="selectAll"> All
        </label>

        <select id="columnSelect" class="toolbar-select">
            <option>Number</option>
            <option>Opened</option>
            <option>Created by</option>
            <option>Short description</option>
            <option>Caller</option>
            <option>School name</option>
            <option>School code</option>
            <option>Priority</option>
            <option>State</option>
            <option>Category</option>
            <option>Assignment group</option>
            <option>Assigned to</option>
            <option>Updated</option>
            <option>Updated by</option>
            <option>Actions</option>
        </select>

        <input type="text" id="globalSearch" class="toolbar-search" placeholder="Search">
     

        <div class="menu-container">
  <div class="menu-button">Incidents ▾</div>

  <div class="menu-panel" style="display:none;">
    <div class="menu-item" data-menu="filters">Filters ▸</div>
    <div class="menu-item" data-menu="groupby">Group By ▸</div>
    <div class="menu-item" data-menu="show">Show ▸</div>
  </div>

  <div class="submenu-panel" id="filters-menu" style="display:none;">
    <div class="submenu-item">All</div>
    <div class="submenu-item">Active</div>
    <div class="submenu-item">Active - Unassigned</div>
    <div class="submenu-item">Assigned to me</div>
    <div class="submenu-item">Closed</div>
  </div>

  <div class="submenu-panel" id="groupby-menu" style="display:none;">
    <div class="submenu-item">--None--</div>
    <div class="submenu-item">Active</div>
    <div class="submenu-item">Assigned to</div>
    <div class="submenu-item">Caller</div>
    <div class="submenu-item">Assignment group</div>
    <div class="submenu-item">Category</div>
    <div class="submenu-item">Created by</div>
    <div class="submenu-item">Updated by</div>
    <div class="submenu-item">Short description</div>
    <div class="submenu-item">State</div>
    <div class="submenu-item">Priority</div>
  </div>

  <div class="submenu-panel" id="show-menu" style="display:none;">
    <div class="submenu-item">All</div>
    <div class="submenu-item">10 rows per page</div>
    <div class="submenu-item">15 rows per page</div>
    <div class="submenu-item">20 rows per page</div>
    <div class="submenu-item">50 rows per page</div>
    <div class="submenu-item">100 rows per page</div>
  </div>
</div>


    </div>
</div>

    <table id="incidentsTable">

    <thead>
        <tr>
            <th></th>
            <th data-col="number">Number </th>
            <th data-col="opened">Opened <span class="col-menu">⋮</span></th>
            <th data-col="created">Created by <span class="col-menu">⋮</span></th>
            <th data-col="desc">Short description <span class="col-menu">⋮</span></th>
            <th data-col="caller">Caller <span class="col-menu">⋮</span></th>
            <th data-col="school_name">School name <span class="col-menu">⋮</span></th>
            <th data-col="school_code">School code <span class="col-menu">⋮</span></th>
            <th data-col="priority">Priority <span class="col-menu">⋮</span></th>
            <th data-col="time_left">Time Left <span class="col-menu">⋮</span></th>
            <th data-col="state">State <span class="col-menu">⋮</span></th>
            <th data-col="category">Category <span class="col-menu">⋮</span></th>
            <th data-col="assignGroup">Assignment group <span class="col-menu">⋮</span></th>
            <th data-col="assignedTo">Assigned to <span class="col-menu">⋮</span></th>
            <th data-col="updated">Updated <span class="col-menu">⋮</span></th>
            <th data-col="updatedBy">Updated by <span class="col-menu">⋮</span></th>
            <th data-col="actions">Actions</th>
        </tr>

        <tr class="search-row">
            <td></td>
            <td><input type="text" data-col="number" placeholder="Search"></td>
            <td><input type="text" data-col="opened" placeholder="Search"></td>
            <td><input type="text" data-col="created" placeholder="Search"></td>
            <td><input type="text" data-col="desc" placeholder="Search"></td>
            <td><input type="text" data-col="caller" placeholder="Search"></td>
            <td><input type="text" data-col="school_name" placeholder="Search"></td>
            <td><input type="text" data-col="school_code" placeholder="Search"></td>
            <td><input type="text" data-col="priority" placeholder="Search"></td>
            <td><input type="text" data-col="time_left" placeholder="Search"></td>
            <td><input type="text" data-col="state" placeholder="Search"></td>
            <td><input type="text" data-col="category" placeholder="Search"></td>
            <td><input type="text" data-col="assignGroup" placeholder="Search"></td>
            <td><input type="text" data-col="assignedTo" placeholder="Search"></td>
            <td><input type="text" data-col="updated" placeholder="Search"></td>
            <td><input type="text" data-col="updatedBy" placeholder="Search"></td>
            <td></td>
        </tr>
    </thead>
    <tbody id="tableBody">
        {% for ticket in tickets %}
        <tr data-number="{{ ticket.number }}">
            <td><input type="checkbox" name="selected_tickets" value="{{ ticket.id }}" class="rowCheck"></td>
            <td><a href="{% url 'update' ticket_id=ticket.id %}">{{ ticket.number }}</a></td>
            <td>{% localtime on %}{{ ticket.created_at|date:"M. d, Y, P" }}{% endlocaltime %}</td>
            <td>{{ ticket.created_by }}</td>
            <td>{{ ticket.short_description }}</td>
            <td>{{ ticket.caller }}</td>
            <td>{{ ticket.school_name }}</td>
            <td>{{ ticket.school_code }}</td>
            <td>{{ ticket.priority }}</td>
            <!-- <td class="{% if ticket.time_left == 'Overdue' %}overdue{% else %}{% if ticket.time_left != 'No SLA' %}sla-ok{% endif %}{% endif %}">
                {{ ticket.time_left }}
            </td>  -->
            <td class="time-left-cell">
                <span class="time-badge badge-{{ ticket.time_left_badge_class }}">
                    {% if ticket.time_left == 'Overdue' %}
                        <i class="fas fa-exclamation-triangle"></i>
                    {% elif ticket.time_left == 'No SLA' %}
                        <i class="fas fa-ban"></i>
                    {% else %}
                        <i class="fas fa-clock"></i>
                    {% endif %}
                    {{ ticket.time_left }}
                </span>
            </td>
            <td>{{ ticket.get_state_display }}</td>
            <td>{{ ticket.get_category_display }}</td>
            <td>{{ ticket.assignment_group }}</td>
            <td>{{ ticket.assigned_to }}</td>
            <td>{% localtime on %}{{ ticket.updated_at|date:"M. d, Y, P" }}{% endlocaltime %}</td>
            <td>{{ ticket.updated_by }}</td>
            <td class="actions">
                {% if ticket.caller_email %}
                <a href="mailto:{{ ticket.caller_email }}?subject=Regarding%20Ticket%20{{ ticket.number }}&body=Dear Sir/Madam,%0D%0A%0D%0A Regards,%0D%0AIT%20Support%20Team%0D%0AEdship%20Technologies">
                    <img src="https://img.icons8.com/ios-glyphs/18/new-post.png" alt="Email">
                </a>
                {% else %}
                <img src="https://img.icons8.com/ios-glyphs/18/new-post.png" alt="Email">
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="columnMenuTemplate" style="display:none;">
    <div class="column-menu">
        <div class="menu-item" data-action="sort-asc">Sort (a to z)</div>
        <div class="menu-item" data-action="sort-desc">Sort (z to a)</div>
        <hr>
        <div class="menu-item" data-action="group">Group By</div>
        <div class="menu-item" data-action="ungroup">Ungroup</div>
        <hr>
        <div class="menu-item" data-action="taskboard">Show Visual Task Board</div>
        <div class="menu-item" data-action="bar">Bar Chart</div>
        <div class="menu-item" data-action="pie">Pie Chart</div>
    </div>
</div>
   <div class="pagination">
    <span>
        {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ page_obj.previous_page_number }}">previous</a>
        {% endif %}

        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
        {% endif %}
    </span>
</div>

</div>
      </div>
        </fieldset>
      </div>
    </div>
    </div>
    </div>


<script>
const table         = document.getElementById('incidentsTable');
const tbody         = document.getElementById('tableBody');
const rows          = () => tbody.querySelectorAll('tr:not(.group-header)');
const globalInp     = document.getElementById('globalSearch');
const colInputs     = table.querySelectorAll('.search-row input');
let currentGroupCol = null;

function filterTable() {
    const global = globalInp.value.trim().toLowerCase();
    const filters = {};
    colInputs.forEach(inp => {
        if (inp.value.trim()) filters[inp.dataset.col] = inp.value.trim().toLowerCase();
    });

    rows().forEach(row => {
        const cells = row.querySelectorAll('td');
        let show = true;

        if (global && !row.textContent.toLowerCase().includes(global)) show = false;

        for (const col in filters) {
            const th = [...table.querySelectorAll('th')].find(t => t.dataset.col === col);
            if (!th) continue;
            const idx = [...table.querySelectorAll('th')].indexOf(th);
            if (!cells[idx].textContent.toLowerCase().includes(filters[col])) show = false;
        }

        row.style.display = show ? '' : 'none';
    });
}
globalInp.addEventListener('input', filterTable);
colInputs.forEach(inp => inp.addEventListener('input', filterTable));


const selectAll = document.getElementById('selectAll');
const rowChecks = table.querySelectorAll('.rowCheck');

function syncSelectAll() {
    const visible = [...rows()].filter(r => r.style.display !== 'none');
    const checked = visible.filter(r => r.querySelector('.rowCheck').checked);
    selectAll.indeterminate = checked.length > 0 && checked.length < visible.length;
    selectAll.checked = checked.length === visible.length && visible.length > 0;
}
selectAll.addEventListener('change', () => {
    const visible = [...rows()].filter(r => r.style.display !== 'none');
    visible.forEach(r => r.querySelector('.rowCheck').checked = selectAll.checked);
});
table.addEventListener('change', e => { if (e.target.classList.contains('rowCheck')) syncSelectAll(); });


let activeMenu = null;

document.addEventListener('click', e => {
    const isMenuClick = e.target.classList.contains('col-menu');
    const isInsideMenu = e.target.closest && e.target.closest('.column-menu');

    if (!isMenuClick && !isInsideMenu && activeMenu) {
        activeMenu.remove();
        activeMenu = null;
        return;
    }

    if (isMenuClick) {
        if (activeMenu) activeMenu.remove();

        const template = document.getElementById('columnMenuTemplate').firstElementChild.cloneNode(true);
        const th = e.target.parentElement;
        const col = th.dataset.col;

        template.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.dataset.action;
                if (action === 'sort-asc') sortColumn(col, true);
                if (action === 'sort-desc') sortColumn(col, false);
                if (action === 'group') groupByColumn(col);
                if (action === 'ungroup') ungroup();
                if (action === 'taskboard') alert('Visual Task Board – not implemented');
                template.remove();
                activeMenu = null;
            });
        });

        th.style.position = 'relative';
        th.appendChild(template);

        const rect = th.getBoundingClientRect();
        template.style.top = `${th.offsetHeight + 2}px`;
        template.style.left = `${rect.width - template.offsetWidth}px`; 
        template.style.transform = 'translateX(-8px)';

        activeMenu = template;
    }
});

function sortColumn(colKey, ascending = true) {
    const ths = table.querySelectorAll('th');
    let idx = -1;
    ths.forEach((th, i) => { if (th.dataset.col === colKey) idx = i; });

    const arr = Array.from(rows());
    arr.sort((a, b) => {
        const aVal = a.children[idx].textContent.trim();
        const bVal = b.children[idx].textContent.trim();
        const aDate = Date.parse(aVal);
        const bDate = Date.parse(bVal);
        if (!isNaN(aDate) && !isNaN(bDate)) {
            return ascending ? aDate - bDate : bDate - aDate;
        }
        return ascending
            ? aVal.localeCompare(bVal)
            : bVal.localeCompare(aVal);
    });

    ungroup();
    arr.forEach(r => tbody.appendChild(r));
}

function groupByColumn(colKey) {
    ungroup();                    
    currentGroupCol = colKey;

    const ths = table.querySelectorAll('th');
    let idx = -1;
    ths.forEach((th, i) => { if (th.dataset.col === colKey) idx = i; });

    const map = new Map();
    rows().forEach(row => {
        const key = row.children[idx].textContent.trim() || '(empty)';
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(row);
    });

    const sortedKeys = [...map.keys()].sort((a, b) => a.localeCompare(b));

    sortedKeys.forEach(key => {
        const groupHeader = document.createElement('tr');
        groupHeader.className = 'group-header collapsed';  
        groupHeader.dataset.groupKey = key;

        const cell = document.createElement('td');
        cell.colSpan = table.querySelectorAll('th').length;

        cell.innerHTML = `<span class="group-arrow">▶</span> <span style="margin-left: 28px;">${key}</span> 
            <span style="color:#666; font-weight:normal; margin-left:8px;">(${map.get(key).length})</span>`;
        groupHeader.appendChild(cell);
        tbody.appendChild(groupHeader);

        const groupRows = map.get(key);
        groupRows.forEach(r => {
            r.classList.add('group-member');
            r.style.display = 'none';          
            tbody.appendChild(r);
        });
    });

    tbody.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', function () {
            this.classList.toggle('collapsed');

            const arrow = this.querySelector('.group-arrow');
            if (this.classList.contains('collapsed')) {
                arrow.textContent = '▶';
            } else {
                arrow.textContent = '▼';
            }

            let next = this.nextElementSibling;
            while (next && next.classList.contains('group-member')) {
                next.style.display = this.classList.contains('collapsed') ? 'none' : '';
                next = next.nextElementSibling;
            }
        });
    });
}


function ungroup() {
    document.querySelectorAll('.group-header').forEach(header => header.remove());
    document.querySelectorAll('tr').forEach(row => {
        if (!row.querySelector('th') && !row.classList.contains('search-row'))
        { 
            row.style.display = '';          
            row.classList.remove('group-member');
        }
    });

    currentGroupCol = null;
}

syncSelectAll();
</script>



<script>
    const menuBtn = document.querySelector(".menu-button");
    const menuPanel = document.querySelector(".menu-panel");
    const submenuPanels = document.querySelectorAll(".submenu-panel");
    const currentUsername = document.getElementById("currentUsername")?.textContent.trim() || "";
    const currentUserFullName = document.getElementById("currentUserFullName")?.textContent.trim() || currentUsername;

    let rowsPerPage = 20;
    let currentFilter = "all";

    // Fixed: Include group headers and members properly
    function getAllDataRows() {
        return Array.from(tbody.querySelectorAll('tr')).filter(tr => 
            !tr.querySelector('th') && !tr.classList.contains('search-row')
        );
    }

    function applyFiltersAndPagination() {
        const allDataRows = getAllDataRows();
        let filteredRows = allDataRows;

        // === APPLY FILTER: Active, Closed, etc. ===
        if (currentFilter === "active") {
            filteredRows = allDataRows.filter(row => {
                const state = row.cells[10]?.textContent.trim(); 
                return !['Closed', 'Resolved', 'Canceled'].includes(state);
            });
        } else if (currentFilter === "active-unassigned") {
            filteredRows = allDataRows.filter(row => {
                const state = row.cells[10]?.textContent.trim();
                const assignedTo = row.cells[13]?.textContent.trim();
                return !['Closed', 'Resolved', 'Canceled'].includes(state) && 
                       (!assignedTo || assignedTo === '' || assignedTo === 'None');
            });
        } else if (currentFilter === "assigned-to-me") {
            filteredRows = allDataRows.filter(row => {
                const assignedTo = row.cells[13]?.textContent.trim(); 
             
                return assignedTo === currentUsername || assignedTo === currentUserFullName;
            });
        } 
        else if (currentFilter === "closed") {
            filteredRows = allDataRows.filter(row => {
            const state = row.cells[10]?.textContent.trim().toLowerCase(); 
            return ['closed','canceled'].includes(state); 
        });
        }
       
        const global = globalInp.value.trim().toLowerCase();
        const colFilters = {};
        colInputs.forEach(inp => {
            if (inp.value.trim()) colFilters[inp.dataset.col] = inp.value.trim().toLowerCase();
        });

        const finalVisibleRows = filteredRows.filter(row => {
            const rowText = row.textContent.toLowerCase();
            if (global && !rowText.includes(global)) return false;

            for (const col in colFilters) {
                const th = [...table.querySelectorAll('th')].find(t => t.dataset.col === col);
                if (!th) continue;
                const idx = [...table.querySelectorAll('th')].indexOf(th);
                const cellText = row.cells[idx]?.textContent.toLowerCase() || '';
                if (!cellText.includes(colFilters[col])) return false;
            }
            return true;
        });


        const isGrouped = currentGroupCol !== null;

        if (isGrouped) {
          
            tbody.querySelectorAll('.group-member').forEach(r => r.style.display = 'none');
            tbody.querySelectorAll('.group-header').forEach(h => {
                h.style.display = '';
                const key = h.dataset.groupKey;
                const members = tbody.querySelectorAll(`.group-member`);
                let visibleInGroup = 0;

                members.forEach(member => {
                    if (finalVisibleRows.includes(member)) visibleInGroup++;
                });

  
                const countSpan = h.querySelector('span:last-child');
                if (countSpan) countSpan.textContent = `(${visibleInGroup})`;

         
                if (visibleInGroup > 0) {
                    h.classList.remove('collapsed');
                    h.querySelector('.group-arrow').textContent = '▼';
                
                    members.forEach(member => {
                        if (finalVisibleRows.includes(member) && 
                            member.closest('tr')?.previousElementSibling?.dataset.groupKey === key) {
                            member.style.display = '';
                        }
                    });
                } else {
                    h.classList.add('collapsed');
                    h.querySelector('.group-arrow').textContent = '▶';
                }
            });
         } 
    
         else {
         
            allDataRows.forEach(row => {
                const shouldShow = finalVisibleRows.includes(row);
                row.style.display = shouldShow ? '' : 'none';
            });

       
            let count = 0;
            allDataRows.forEach(row => {
                if (row.style.display !== 'none') {
                    row.style.display = count < rowsPerPage ? '' : 'none';
                    count++;
                }
            });
        }

        const total = finalVisibleRows.length;
        const showing = Math.min(total, rowsPerPage);
        const infoSpan = document.querySelector('.pagination span span');
        if (infoSpan) infoSpan.remove();
        document.querySelector('.pagination span')?.insertAdjacentHTML('beforeend', 
            ` <span style="margin-left:20px;color:#555;">Showing 1–${total > 0 ? showing : 0} of ${total}</span>`
        );

        syncSelectAll();
    }

    // Re-apply on search
    globalInp.addEventListener('input', () => setTimeout(applyFiltersAndPagination, 10));
    colInputs.forEach(inp => inp.addEventListener('input', () => setTimeout(applyFiltersAndPagination, 10)));

    // Menu controls
    menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menuPanel.style.display = menuPanel.style.display === "block" ? "none" : "block";
        submenuPanels.forEach(m => m.style.display = "none");
    });

    document.querySelectorAll(".menu-item").forEach(item => {
        item.addEventListener("mouseenter", () => {
            submenuPanels.forEach(m => m.style.display = "none");
            const submenu = document.getElementById(item.dataset.menu + "-menu");
            if (submenu) submenu.style.display = "block";
        });
    });

    document.addEventListener("click", (e) => {
        if (!e.target.closest(".menu-container")) {
            menuPanel.style.display = "none";
            submenuPanels.forEach(m => m.style.display = "none");
        }
    });

    // FILTERS
    document.querySelectorAll("#filters-menu .submenu-item").forEach(item => {
        item.addEventListener("click", () => {
            const text = item.textContent.trim();
            currentFilter = {
                "All": "all",
                "Active": "active",
                "Active - Unassigned": "active-unassigned",
                "Assigned to me": "assigned-to-me",
                "Closed": "closed"
            }[text] || "all";

            document.querySelectorAll("#filters-menu .submenu-item").forEach(i => i.style.fontWeight = "normal");
            item.style.fontWeight = "bold";

            applyFiltersAndPagination();
            menuPanel.style.display = "none";
            submenuPanels.forEach(m => m.style.display = "none");
        });
    });

    // SHOW (rows per page)
    document.querySelectorAll("#show-menu .submenu-item").forEach(item => {
        item.addEventListener("click", () => {
            const text = item.textContent.trim();
            if (text.includes("All")) {
                rowsPerPage = 9999;
            } else {
                const num = parseInt(text);
                rowsPerPage = isNaN(num) ? 20 : num;
            }

            document.querySelectorAll("#show-menu .submenu-item").forEach(i => i.style.fontWeight = "normal");
            item.style.fontWeight = "bold";

            applyFiltersAndPagination();
            menuPanel.style.display = "none";
            submenuPanels.forEach(m => m.style.display = "none");
        });
    });


    //group by menu functionality 
    document.querySelectorAll("#groupby-menu .submenu-item").forEach(item => {
        item.addEventListener("click", () => {
            const group = item.textContent.trim();
            
            // This is the menu closing logic:
            menuPanel.style.display = "none";
            submenuPanels.forEach(m => m.style.display = "none");
            
            if (group === "-- None --") { ungroup(); return; }

            let colKey = null;

            if (group === "Active") colKey = "state"; 
            if (group === "Assigned to") colKey = "assignedTo";
            if (group === "Caller") colKey = "caller";
            if (group === "Assignment group") colKey = "assignGroup";
            if (group === "Category") colKey = "category";
            if (group === "Created by") colKey = "created";
            if (group === "Updated by") colKey = "updatedBy";
            if (group === "Short description") colKey = "desc"; 
            if (group === "State") colKey = "state";
            if (group === "Priority") colKey = "priority";

            if (colKey) groupByColumn(colKey);
        });
    });

    document.querySelector("#filters-menu .submenu-item").style.fontWeight = "bold";
    document.querySelector('#show-menu .submenu-item:nth-child(4)').style.fontWeight = "bold"; // 20 rows
    applyFiltersAndPagination();
</script>

<script>

document.addEventListener('DOMContentLoaded', () => {
    const dropdownContainer = document.querySelector('.topbar-dropdown-container');
    const dropdownToggle = document.querySelector('.topbar-dropdown-toggle');
    
    if (dropdownContainer && dropdownToggle) {
        
        function closeDropdown() {
            dropdownContainer.classList.remove('open');
        }

        // Toggle the dropdown menu visibility on click
        dropdownToggle.addEventListener('click', (e) => {
            const isOpen = dropdownContainer.classList.contains('open');

            if (isOpen) {
                 // If the menu is already open, clicking again should navigate (default action)
                 closeDropdown();
            } else {
                 // On first click, open the menu (prevents navigation)
                 e.preventDefault(); 
                 dropdownContainer.classList.add('open');
            }
        });

        // Close the dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.topbar-dropdown-container')) {
                closeDropdown();
            }
        });
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const profileBtn = document.querySelector('.profile-btn');
    const profileMenu = document.querySelector('.profile-menu');
    
    if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            profileMenu.classList.toggle('open');
        });
        
        document.addEventListener('click', function() {
            profileMenu.classList.remove('open');
        });
    }
});
</script>

</body>
</html>


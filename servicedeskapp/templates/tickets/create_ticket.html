{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Incident - New Record</title>
    <link rel="stylesheet" href="{% static 'create_ticket.css' %}">
</head>

<body>
    <div class="topbar">
    <div class="topbar-brand">Ticket Management</div>
    <nav class="topbar-nav">
        <a href="{% url 'overview' %}">Overview</a>
        <div class="topbar-dropdown-container">
        <a href="{% url 'dashboard' %}" class="active topbar-dropdown-toggle">
            Tickets <span class="dropdown-arrow">â–¼</span>
        </a>
        <div class="topbar-dropdown-menu">
            <a href="{% url 'caller_details' %}" id="caller-details-link" class="dropdown-item">Caller Details</a>
        </div>
    </div>
        {% if request.session.role == 'admin' %}
            <a href="{% url 'user_management' %}">User Management</a>
            <a href="{% url 'master_data' %}">Master Data</a>
            <a href="{% url 'reports' %}">Reports</a>
        {% endif %}
    </nav>
     <div class="topbar-user">
        <span>Welcome, {{ request.session.name|default:request.session.username }}</span>
    <div class="profile-dropdown">
        <button class="profile-btn" title="User Menu">
            <svg class="profile-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <!-- <span class="user-initials">{{ request.session.name|default:request.session.username|slice:":1"|upper }}</span> -->
        </button>
        <div class="profile-menu">
            <a href="{% url 'reset' %}" class="profile-menu-item">Reset Password</a>
            <a href="{% url 'logout' %}" class="profile-menu-item">Logout</a>
        </div>
    </div>
</div>
</div>
    <div class="main-content">
             {% if messages %}
            {% for message in messages %}
              <div style="background-color:#ffcccc; color:#f05454; padding:10px; border-radius:5px; margin-bottom:10px; font-weight:500;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
            <form class="incident-form" action="{% url 'create' %}" method="post">
            {% csrf_token %}
           <div class="action-buttons-top">
                <a href="{% url 'dashboard' %}"><button type="submit" class="action-btn-top submit">Submit</button></a>
                <button class="action-btn-top resolve">Resolve</button>
            </div>
          <fieldset class="ticket-fieldset">
         <legend>Create Ticket</legend>
            <div class="form-row">
                <div class="form-group">
                    <label>School Name <span class="required">*</span></label>
                    <input type="text" name="school_name" placeholder="Enter school name" id="school_name_input" 
                    autocomplete="off" required value="{{ latest_school_name|default:'' }}">
                    <div id="school_suggestions" class="autocomplete-items"></div>
                </div>
                <div class="form-group">
                    <label>School Code</label>
                    <input type="text" name="school_code" placeholder="Enter school code" id="school_code_input" value="{{ latest_school_code|default:'' }}">
                    
                </div>
                <div class="form-group">
                    <label>Caller <span class="required">*</span></label>
                    <input type="text" id="caller_field" class="form-control" name="caller" value="{{ latest_caller }}" 
                        placeholder="Click to add caller details" readonly onclick="openCallerModal()" value="{{ latest_caller|default:'' }}">
                    <input type="hidden" name="caller_details_id" value="{{ request.session.last_caller_id|default:'' }}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                     <div class="form-group">
                    <label>Number</label>
                    <input type="text" value="{{ next_number }}" readonly class="form-control readonly-input">
                    <input type="hidden" name="number" value="{{ next_number }}">
                </div>
                </div>
                 <div class="form-group">
                    <label>Platform<span class="required">*</span></label>
                    <select name="platform" required>
                        <option value="">Select platform</option>
                        <option value="web application">Web Application</option>
                        <option value="mobile application">Mobile Application</option>
                    </select>
                </div>
                     <div class="form-group">
                    <label>Category<span class="required">*</span></label>
                    <select name="category" required>
                        <option value="">Select category</option>
                        <option value="inquiry/help">Inquiry / Help</option>
                        <option value="software">Software</option>
                        <option value="hardware">Hardware</option>
                        <option value="network">Network</option>
                        <option value="database">Database</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Channel</label>
                    <select name="channel">
                        <option value="">Select channel</option>
                        <option value="email">Email</option>
                        <option value="phone">Phone</option>
                        <option value="self-service">Self-service</option>
                        <option value="virtual agent">Virtual Agent</option>
                        <option value="chat">Chat</option>
                        <option value="walk-in">Walk-in</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>State<span class="required">*</span></label>
                    <select name="state" required>
                        <option value="">Select state</option>
                        <option value="new" selected>New</option>
                        <option value="in progress" disabled>In Progress</option>
                        <option value="on hold" disabled>On Hold</option>
                        <option value="resolved" disabled>Resolved</option>
                        <option value="closed" disabled>Closed</option>
                        <option value="cancelled" disabled>Cancelled</option>
                    </select>
                </div>
                  <div class="form-group">
                    <label>Modules</label>
                    <select name="modules">
                        <option value="">Select modules</option>
                        <option value="anti-virus">Anti-virus</option>
                        <option value="email">Email</option>
                        <option value="internal application">Internal Application</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Urgency<span class="required">*</span></label>
                    <select name="urgency" required>
                        <option value="">Select urgency</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select name="priority" required>
                        <option value="" disabled selected>Select Priority</option>
                        {% for p in priorities %}
                            <option value="{{ p.id }}">{{ p.get_name_display }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="form-group">
                    <label>Impact</label>
                    <select name="impact">
                        <option value="">Select impact</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Assigned Group<span class="required">*</span></label>
                    <a href="{% url 'assigned' %}?source_page=create" class="fake-input">
                        {% if selected_group %}
                        {{ selected_group }}
                        {% else %}
                        Select assignment group
                        {% endif %}
                    </a>
                    <input type="hidden" name="assignment_group" value="{{ selected_group }}" required>            
                 </div>
                <div class="form-group">
                    <label>Assigned To</label>
                    <select name="assigned_to">
                        <option value="">Select</option>
                        {% if group_members %}
                        {% for member in group_members %}
                        <option value="{{ member.user.name }}">{{ member.user.name }}</option>
                        {% endfor %}

                        {% endif %}
                    </select>
                </div>
                 <div class="form-group">
                    <label>Created by</label>
                    <input type="text" name="created_by" value="{{ request.session.username }}" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Updated By</label>
                    <input type="text" name="updated_by" readonly>
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Short Description<span class="required">*</span></label>
                    <input type="text" name="short_description" placeholder="Brief summary of the issue" required>
                </div>
            </div>
            <div class="form-row desc">
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" placeholder="Enter description here..."></textarea>
                </div>
            </div>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button type="button" class="tab-btn active" onclick="showTab(event, 'notes')">Notes</button>
                    <button type="button" class="tab-btn" onclick="showTab(event, 'related-records')">Related Records</button>
                    <button type="button" class="tab-btn" onclick="showTab(event, 'resolution-info')">Resolution Information</button>
                </div>
                <div id="notes" class="tab-content show">
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Additional Comments <span class="customer-visible">(Customer Visible)</span></label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="text" name="additional_comments" placeholder="" >
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Work Notes</label>
                        </div>
                        <div class="form-group notes-input">
                            <textarea name="work_notes" placeholder=""></textarea>
                        </div>
                    </div>
                </div>
                <div id="related-records" class="tab-content">
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Parent Incident</label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="text" name="parent_incident" placeholder="" >
            
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Problem</label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="text" name="problem" placeholder="">
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Change Request</label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="text" name="change_request" placeholder="" />
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Caused by Change</label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="text" name="caused_by_change" placeholder="" />
                        </div>
                    </div>
                </div>
                <div id="resolution-info" class="tab-content">
                    <!-- <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Knowledge</label>
                        </div>
                        <div class="form-group notes-input" style="align-items: flex-start;">
                            <input type="checkbox" name="knowledge">
                        </div>
                    </div> -->
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Resolved By</label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="text" name="resolved_by" placeholder="">
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Resolution Code</label>
                        </div>
                        <div class="form-group notes-input">
                            <select name="resolution_code">
                                <option>-- None --</option>
                                <option>Fixed</option>
                                <option>Won't Fix</option>
                                <option>Duplicate</option>
                            </select>
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Resolved date</label>
                        </div>
                        <div class="form-group notes-input">
                            <input type="date" name="resolved_at">
                        </div>
                    </div>
                    <div class="notes-row">
                        <div class="form-group notes-label">
                            <label>Resolution Notes</label>
                        </div>
                        <div class="form-group notes-input">
                            <textarea name="resolution_notes" placeholder="Enter resolution details..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
            <div class="action-buttons">
                <button type="submit" class="action-btn submit">Submit</button>
                <button type="button" class="action-btn resolve">Resolve</button>
            </div>
        </form>
    </div>
 </div>

  <div id="callerModal" class="modal">
  <div class="modal-content">
    <!-- <span class="close">&times;</span> -->
    <h2>Add Caller Details</h2>
    <form method="post" action="{% url 'add_caller_details' %}">
      {% csrf_token %}
      <input type="hidden" name="ticket_school_name" value="{{ school_name }}">
      <input type="hidden" name="ticket_school_code" value="{{ school_code }}">
      
      <input type="text" name="caller_name" placeholder="Name" required>
      <input type="text" name="caller_role" placeholder="Role" required>
      <input type="email" name="caller_email" placeholder="Email" required>
      <input type="tel" name="caller_phone" placeholder="Phone" required>
      <input type="text" name="school_name" id="modal_school_name" placeholder="School Name">
      <input type="text" name="school_code" id="modal_school_code" placeholder="School Code">
      
      <button type="submit" name="save">Save</button>
      <button type="button" onclick="closeModal()">Cancel</button>
    </form>
  </div>
</div>

 <script>
 function showTab(evt, tabName) {
    var i, tabcontent, tabbtns;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].classList.remove("show");
    }
    tabbtns = document.getElementsByClassName("tab-btn");
    for (i = 0; i < tabbtns.length; i++) {
      tabbtns[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("show");
    evt.currentTarget.classList.add("active");
  }
 </script>

<script>
  // Save form data including hidden fields before leaving the page
  window.addEventListener("beforeunload", function() {
    const form = document.querySelector("form.incident-form");
    if (!form) return;
    const data = {};
    new FormData(form).forEach((value, key) => {
      data[key] = value;
    });
    localStorage.setItem("ticketFormData", JSON.stringify(data));
  });

  // On page load, restore saved form data only when coming from assignment group
  window.addEventListener("load", function() {
    const urlParams = new URLSearchParams(window.location.search);

    // ðŸ§¹ If it's a brand new Add Ticket (no assignment_group param), clear old data
    if (!urlParams.has("assignment_group")) {
      localStorage.removeItem("ticketFormData");
      return; // stop restoring â€” start clean
    }

    // âœ… If user came back from selecting a group, restore saved fields
    const savedData = localStorage.getItem("ticketFormData");
    if (savedData) {
      const data = JSON.parse(savedData);

      Object.keys(data).forEach(key => {
        if (key === "assignment_group") return; // don't override backend group
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
          if (field.type === "checkbox") {
            field.checked = data[key] === "on";
          } else {
            field.value = data[key];
          }
        }
      });

      // âœ… Restore hidden assignment_group if backend didn't set one
      const hiddenGroup = document.querySelector('input[name="assignment_group"]');
      if (hiddenGroup && data['assignment_group'] && !hiddenGroup.value) {
        hiddenGroup.value = data['assignment_group'];
      }

      // remove stored data after restoring
      localStorage.removeItem("ticketFormData");
    }
  });

  // Clear saved data when the form is successfully submitted
  document.querySelector("form.incident-form").addEventListener("submit", function() {
    const assignGroupVal = document.querySelector('input[name="assignment_group"]').value;
    console.log("Submitting assignment_group:", assignGroupVal);
    localStorage.removeItem("ticketFormData");
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const nameInput = document.getElementById('school_name_input');
    const codeInput = document.getElementById('school_code_input');
    const suggestionBox = document.getElementById('school_suggestions');

    let currentSuggestions = [];

    nameInput.addEventListener('input', function() {
        const query = nameInput.value;
        if (!query) {
            suggestionBox.innerHTML = '';
            return;
        }
        fetch(`school_autofill?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(schools => {
                currentSuggestions = schools;
                suggestionBox.innerHTML = '';
                schools.forEach(school => {
                    const div = document.createElement('div');
                    div.textContent = school.name;
                    div.className = "autocomplete-item";
                    div.onclick = function() {
                        nameInput.value = school.name;
                        codeInput.value = school.code;
                        suggestionBox.innerHTML = '';
                    };
                    suggestionBox.appendChild(div);
                });
            });
    });

    // Optionally, hide suggestions when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!suggestionBox.contains(e.target) && e.target !== nameInput) {
            suggestionBox.innerHTML = '';
        }
    });
});
</script>

<script>
    // Save form data to sessionStorage before opening modal
function saveFormData() {
    const formData = {};
    document.querySelectorAll('#createTicketForm input, #createTicketForm select, #createTicketForm textarea').forEach(el => {
        formData[el.name] = el.value;
    });
    sessionStorage.setItem('ticketFormData', JSON.stringify(formData));
}

// Restore form data from sessionStorage
function restoreFormData() {
    const savedData = sessionStorage.getItem('ticketFormData');
    if (savedData) {
        const formData = JSON.parse(savedData);
        Object.keys(formData).forEach(key => {
            const el = document.querySelector(`[name="${key}"]`);
            if (el) el.value = formData[key];
        });
    }
}

// Open modal with autofill
document.getElementById('caller_field').addEventListener('click', function() {
    saveFormData();
    
    // Autofill school details
    document.getElementById('modal_school_name').value = 
        document.querySelector('[name="school_name"]').value;
    document.getElementById('modal_school_code').value = 
        document.querySelector('[name="school_code"]').value;
    
    document.getElementById('callerModal').style.display = 'block';
});

// Close modal without page reload
function closeModal() {
    document.getElementById('callerModal').style.display = 'none';
    restoreFormData(); // Restore original form data
}

</script>

<script>
window.onload = function () {
    const params = new URLSearchParams(window.location.search);
    
    // Handle assignment group return - RESTORE ALL fields including school/caller
    if (params.has("assignment_group")) {
        const savedData = localStorage.getItem("ticketFormData");
        if (savedData) {
            const data = JSON.parse(savedData);
            Object.keys(data).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === "checkbox") {
                        field.checked = (data[key] === "on");
                    } else {
                        field.value = data[key];
                    }
                }
            });
            localStorage.removeItem("ticketFormData");
        }
        return; // Exit early - assignment group handled
    }
    
    // Handle caller modal return
    const fromCaller = params.get('from_caller');
    const callerName = "{{ latest_caller|default:'' }}";
    const schoolName = "{{ latest_school_name|default:'' }}";
    const schoolCode = "{{ latest_school_code|default:'' }}";
    
    if (fromCaller && (callerName || schoolName || schoolCode)) {
        if (callerName) document.getElementById('caller_field').value = callerName;
        if (schoolName) document.getElementById('school_name_input').value = schoolName;
        if (schoolCode) document.getElementById('school_code_input').value = schoolCode;
    }
    
    // Fresh page load - clear localStorage data only
    if (!params.has("assignment_group") && !params.get('from_caller')) {
        localStorage.removeItem("ticketFormData");
    }
};
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const profileBtn = document.querySelector('.profile-btn');
    const profileMenu = document.querySelector('.profile-menu');
    
    if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            profileMenu.classList.toggle('open');
        });
        
        document.addEventListener('click', function() {
            profileMenu.classList.remove('open');
        });
    }
});

</script>

</body>
</html>
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reports</title>
  <link rel="stylesheet" href="{% static 'reports.css' %}" />
 
</head>
<body>
   <div class="topbar">
    <div class="topbar-brand">Reports</div>
    <nav class="topbar-nav">
        <a href="{% url 'overview' %}">Overview</a>
        <div class="topbar-dropdown-container">
        <a href="{% url 'dashboard' %}" class="topbar-dropdown-toggle">
            Tickets <span class="dropdown-arrow">â–¼</span>
        </a>
        <div class="topbar-dropdown-menu">
            <a href="{% url 'caller_details' %}" id="caller-details-link" class="dropdown-item">Caller Details</a>
        </div>
        </div>
        {% if request.session.role == 'admin' %}
            <a href="{% url 'user_management' %}">User Management</a>
            <a href="{% url 'master_data' %}">Master Data</a>
            <a href="{% url 'reports' %}"   class="active">Reports</a>
        {% endif %}
    </nav>
    <div class="topbar-user">
        <span>Welcome, {{ request.session.name|default:request.session.username }}</span>
    <div class="profile-dropdown">
        <button class="profile-btn" title="User Menu">
            <svg class="profile-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </button>
        <div class="profile-menu">
            <a href="{% url 'reset' %}" class="profile-menu-item">Reset Password</a>
            <a href="{% url 'logout' %}" class="profile-menu-item">Logout</a>
        </div>
    </div>
</div>
</div>


<div class="reports-header">
    <div class="reports-header-top">
        <div class="reports-header-text">
            <h1 class="reports-title">Reports & Analytics</h1>
            <p class="reports-subtitle">Key reports and insights for support tasks</p>
        </div>

        <!-- Generate PDF & Export Data - Top Right -->
        <div class="reports-actions">
            <button class="btn btn-outline">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 10v6m-3-3h6m6 6H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2z"/>
                </svg>
                Generate PDF
            </button>
            <button class="btn btn-primary">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                    <polyline points="16 6 12 2 8 6"/>
                    <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
                Export Data
            </button>
        </div>
    </div>

    <!-- Filters Row - Full width, below title -->
    <div class="reports-filters">
        <div class="filter-dropdown">
            <div class="filter-select-wrapper">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"/>
                </svg>

                <div class="school-dropdown" id="schoolDropdown">
                    <div class="school-selected" id="schoolSelected">
                        All Schools
                    </div>

                    <div class="school-menu" id="schoolMenu">
                        <div class="school-search">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" fill="none"/>
                            <line x1="16.65" y1="16.65" x2="21" y2="21" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <input type="text" id="schoolSearch" placeholder="Search school">
                        </div>

                        <ul class="school-list" id="schoolList">
                        <li data-value="">All Schools</li>
                        {% for s in schools %}
                            <li data-value="{{ s.id }}">{{ s.name }}</li>
                        {% endfor %}
                        </ul>
                    </div>

                    <input type="hidden" name="school" id="schoolInput">
                    </div>


                <svg class="dropdown-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div class="filter-dropdown">
            <div class="filter-date-wrapper" id="date-wrapper">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 8h18M8 4v4M16 4v4M5 8v12h14V8"/>
                </svg>

                <span id="date-display" class="date-display">Select date</span>

                <svg class="dropdown-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 9l-7 7-7-7"/>
                </svg>

                <input type="text" id="date-input" class="date-input-hidden">
            </div>
        </div>

    </div>
</div>
 
<!-- ====================== MAIN CONTENT - REPORTS DASHBOARD ====================== -->

<div class="dashboard-grid">
      <div class="report-card">
    <h2 class="report-card-title">Ticket Duration by Issue Type</h2>
    <p>Average resolution time and ticket count per issue category</p>

    <div class="chart-container ticket-duration-wrapper" style="height: 400px; width: 100%;">
      <canvas id="ticketDurationChart"></canvas>
    </div>
  </div>
    
    <div class="report-card">
    <h2 class="report-card-title">Category Classification</h2>
    <p>Issue distribution by category type</p>

    <div class="chart-container">
        <canvas id="ticketCategoryChart"></canvas>

        <div class="chart-legend" id="categoryLegend">
            {% for label, count in category_legend %}
                <div class="legend-item">
                <!-- <span class="dot"></span>{{ label }}  -->
                <span class="dot dot-{{ forloop.counter0 }}"></span>{{ label }}
                <span class="count">{{ count }}</span>
                </div>
            {% endfor %}
        
        </div>
    </div>
    </div>

    <div class="platform-card">
    <div>
        <h2 class="title">Platform Distribution</h2>
        <p class="subtitle">Tickets by platform source</p>
    </div>

    <div class="platform-content">
        <!-- Donut on the left -->
        <div class="donut-wrapper">
            <div class="donut" id="platform-donut"></div>
            <div class="donut-center-text">
                <div class="center-count" id="center-count-value">560</div>
                <div class="center-label">{{ total_tickets }}</div>
            </div>
        </div>

        <!-- List on the right -->
        <div class="platform-list">
            <div class="platform-item" data-segment="web">
                <div class="platform-left">
                    <div class="platform-icon web"><div class="icon-desktop"></div></div>
                    <div>
                        <div class="platform-text-main">Web</div>
                        <div class="platform-text-sub">Application</div>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="platform-count">{{ web_count }}</div>
                    <div class="platform-progress"><div class="platform-progress-bar web"></div></div>
                   
                </div>
            </div>

            <div class="platform-item" data-segment="mobile">
                <div class="platform-left">
                    <div class="platform-icon mobile"><div class="icon-mobile"></div></div>
                    <div>
                        <div class="platform-text-main">Mobile</div>
                        <div class="platform-text-sub">Application</div>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="platform-count">{{ mobile_count }}</div>
                    <div class="platform-progress"><div class="platform-progress-bar mobile"></div></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
<script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>


<script>
  $(function () {
    const $dateInput = $('#date-input');

    $dateInput.daterangepicker({
      autoUpdateInput: false,
      opens: 'left',
      locale: {
        cancelLabel: 'Clear'
      }
    });

    // CLICK wrapper â†’ open calendar
    document.getElementById('date-wrapper').addEventListener('click', function () {
      $dateInput.trigger('click');
    });

    $dateInput.on('apply.daterangepicker', function (ev, picker) {
      document.getElementById('date-display').textContent =
        picker.startDate.format('DD MMM YYYY') +
        ' - ' +
        picker.endDate.format('DD MMM YYYY');
     fetchReports(); // ðŸ”¥ update reports
    });

    $dateInput.on('cancel.daterangepicker', function () {
      document.getElementById('date-display').textContent = 'Select date';
    });
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
const ctx = document.getElementById('ticketCategoryChart').getContext('2d');

const categoryChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: JSON.parse('{{ category_labels|escapejs }}'),
        datasets: [{
            data: JSON.parse('{{ category_data|escapejs }}'),
            backgroundColor: ['#e74c3c','#f39c12','#16a085',
                              '#3498db','#8e44ad','#1abc9c'],
            borderRadius: 6
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>
<script>
// Ticket Duration chart (dual axis)
const ticketDurationCtx = document.getElementById('ticketDurationChart').getContext('2d');

const ticketDurationChart = new Chart(ticketDurationCtx, {
  type: 'bar',
  data: {
    labels: [],      // will be set by fetchReports
    datasets: [
      {
        label: 'Avg Duration (hours)',
        data: [],
        backgroundColor: '#14b8a6',  // teal
        borderRadius: 4,
        yAxisID: 'yDuration',
        barPercentage: 0.8,
        categoryPercentage: 0.6
      },
      {
        label: 'Ticket Count',
        data: [],
        backgroundColor: '#f59e0b',  // orange
        borderRadius: 4,
        yAxisID: 'yTickets',
        barPercentage: 0.8,
        categoryPercentage: 0.6
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
    mode: 'nearest',  // nearest bar
    intersect: false
},
    layout: {
      padding: { top: 10, right: 20, bottom: 10, left: 10 }
    },
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          boxWidth: 14,
          boxHeight: 14
        }
      },
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        callbacks: {
          title: (items) => items[0].label,
          label: (ctx) => {
            const dsLabel = ctx.dataset.label || '';
            if (dsLabel.includes('Duration')) {
              return `${dsLabel} : ${ctx.parsed.y} hours`;
            }
            if (dsLabel.includes('Ticket Count')) {
              return `${dsLabel} : ${ctx.parsed.y}`;
            }
            return `${dsLabel} : ${ctx.parsed.y}`;
          }
        }
      }
    },
    scales: {
      x: {
        grid: { display: false }
      },
      yDuration: {
        position: 'left',
        title: {
          display: true,
          text: 'Avg Duration (hours)'
        },
        grid: {
          drawBorder: false
        }
      },
      yTickets: {
        position: 'right',
        title: {
          display: true,
          text: 'Ticket Count'
        },
        grid: {
          drawBorder: false,
          drawOnChartArea: false
        }
      }
    }
  }
});
</script>



<script>
        // Data configuration


        const donut = document.getElementById("platform-donut");
        const items = document.querySelectorAll(".platform-item");
        const centerText = document.getElementById("donut-center-text");
     

        // 1. Animate donut on page load (already mostly working)
        window.addEventListener("load", () => {
            // Add the 'animate' class to trigger the CSS animation
            donut.classList.add("animate");
            
            // For persistence, we add 'final' class after the animation finishes
            setTimeout(() => {
                donut.classList.add("final");
                donut.classList.remove("animate");
            }, 1200); // Match animation duration
        });

        // 2. Hover behavior for each platform row (simulates chart hover for better UX)
        items.forEach((item) => {
            const key = item.dataset.segment;
            const info = DATA[key];

            // Mouse Enter (Hover In)
            item.addEventListener("mouseenter", () => {
                // Display text in the center of the donut
                centerCountValue.textContent = info.count;
                centerLabelValue.textContent = `${info.label} Tickets`;
                centerText.classList.add("visible");
            });

            // Mouse Leave (Hover Out)
            item.addEventListener("mouseleave", () => {
                // Hide text from the center of the donut
                centerText.classList.remove("visible");
            });

            // For accessibility: Focus/Blur
            item.addEventListener("focus", () => {
                centerCountValue.textContent = info.count;
                centerLabelValue.textContent = `${info.label} Tickets`;
                centerText.classList.add("visible");
            });
            item.addEventListener("blur", () => {
                centerText.classList.remove("visible");
            });
        });
        
        // Remove the old click functionality
        // items.forEach((item) => { item.addEventListener("click", () => { ... }) });
    </script>


<script>
// Hover: show real platform count, default = total
const centerCount = document.getElementById("center-count-value");
const centerLabel = document.querySelector(".donut-center-text .center-label");
const totalTickets = "{{ total_tickets }}";

window.addEventListener("load", () => {
    centerCount.textContent = totalTickets;
    centerLabel.textContent = "Total Tickets";
});

document.querySelectorAll(".platform-item").forEach(item => {
    const count = item.querySelector(".platform-count").textContent.trim();
    const name  = item.querySelector(".platform-text-main").textContent.trim();

    item.addEventListener("mouseenter", () => {
        centerCount.textContent = count;
        centerLabel.textContent = name + " Tickets";
    });

    item.addEventListener("mouseleave", () => {
        centerCount.textContent = totalTickets;
        centerLabel.textContent = "Total Tickets";
    });
});
</script>

<script>
  const schoolSelected = document.getElementById("schoolSelected");
  const schoolMenu = document.getElementById("schoolMenu");
  const schoolSearch = document.getElementById("schoolSearch");
  const schoolItems = document.querySelectorAll("#schoolList li");
  const schoolInput = document.getElementById("schoolInput");

  schoolSelected.addEventListener("click", () => {
    schoolMenu.classList.toggle("open");
  });

  schoolItems.forEach(item => {
  item.addEventListener("click", () => {
    schoolSelected.textContent = item.textContent;
    schoolInput.value = item.textContent; // school NAME
    schoolMenu.classList.remove("open");

    fetchReports(); // ðŸ”¥ update reports
  });
});

  schoolSearch.addEventListener("keyup", () => {
    const value = schoolSearch.value.toLowerCase();
    schoolItems.forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(value)
        ? "block"
        : "none";
    });
  });

  document.addEventListener("click", e => {
    if (!e.target.closest(".school-dropdown")) {
      schoolMenu.classList.remove("open");
    }
  });
</script>

<script>
function fetchReports() {
    const school = document.getElementById("schoolInput").value;
    const dateText = document.getElementById("date-display").textContent;

    let startDate = '';
    let endDate = '';

    if (dateText !== 'Select date') {
        const parts = dateText.split(' - ');
        startDate = moment(parts[0], 'DD MMM YYYY').format('YYYY-MM-DD');
        endDate   = moment(parts[1], 'DD MMM YYYY').format('YYYY-MM-DD');
    }

    $.ajax({
        url: "{% url 'reports_data_test' %}",
        data: {
            school: school,
            start_date: startDate,
            end_date: endDate
        },
        success: function(data) {

    // update category bar chart
    categoryChart.data.labels = data.category_labels;
    categoryChart.data.datasets[0].data = data.category_data;
    categoryChart.update();

    // âœ… update ticket duration chart (new)
    ticketDurationChart.data.labels = data.duration_labels;
    ticketDurationChart.data.datasets[0].data = data.duration_avg_hours;   // Avg Duration
    ticketDurationChart.data.datasets[1].data = data.duration_ticket_count; // Ticket Count
    ticketDurationChart.update();

    // update platform numbers
    document.querySelector(".platform-item[data-segment='web'] .platform-count").textContent = data.web_count;
    document.querySelector(".platform-item[data-segment='mobile'] .platform-count").textContent = data.mobile_count;

    // update donut center
    document.getElementById("center-count-value").textContent = data.total_tickets;

    // ðŸ”„ Update category legend (right side)
    const legendContainer = document.getElementById("categoryLegend");
    legendContainer.innerHTML = "";

    data.category_labels.forEach((label, index) => {
        const count = data.category_data[index];
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
            <span class="dot dot-${index}"></span>
            ${label}
            <span class="count">${count}</span>
        `;
        legendContainer.appendChild(item);
    });
}

    });
}
</script>

<script>
window.addEventListener('load', () => {
    fetchReports();
});
</script>

</body>
</html>
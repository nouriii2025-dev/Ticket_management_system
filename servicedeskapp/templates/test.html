{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reports</title>
    <link rel="stylesheet" href="{% static 'test.css' %}" />
</head>
<body>
   <div class="topbar">
    <div class="topbar-brand">Reports</div>
    <nav class="topbar-nav">
        <a href="{% url 'overview' %}">Overview</a>
        <div class="topbar-dropdown-container">
        <a href="{% url 'dashboard' %}" class="topbar-dropdown-toggle">
            Tickets <span class="dropdown-arrow">â–¼</span>
        </a>
        <div class="topbar-dropdown-menu">
            <a href="{% url 'caller_details' %}" id="caller-details-link" class="dropdown-item">Caller Details</a>
        </div>
        </div>
        {% if request.session.role == 'admin' %}
            <a href="{% url 'user_management' %}">User Management</a>
            <a href="{% url 'master_data' %}">Master Data</a>
        {% endif %}
        <a href="{% url 'reports' %}" class="active">Reports</a>
    </nav>
    <div class="topbar-user">
        <span>Welcome, {{ request.session.name|default:request.session.username }}</span>
    <div class="profile-dropdown">
        <button class="profile-btn" title="User Menu">
            <svg class="profile-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </button>
        <div class="profile-menu">
            <a href="{% url 'reset' %}" class="profile-menu-item">Reset Password</a>
            <a href="{% url 'logout' %}" class="profile-menu-item">Logout</a>
        </div>
    </div>
</div>
</div>


<div class="reports-header">
    <div class="reports-header-top">
        <div class="reports-header-text">
            <h1 class="reports-title">Reports & Analytics</h1>
            <p class="reports-subtitle">Key reports and insights for support tasks</p>
        </div>

        <!-- Generate PDF & Export Data - Top Right -->
        <div class="reports-actions">
            <button class="btn btn-outline">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 10v6m-3-3h6m6 6H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2z"/>
                </svg>
                Generate PDF
            </button>
            <button class="btn btn-primary">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                    <polyline points="16 6 12 2 8 6"/>
                    <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
                Export Data
            </button>
        </div>
    </div>

    <!-- Filters Row - Full width, below title -->
    <div class="reports-filters">
        <div class="filter-dropdown">
            <div class="filter-select-wrapper">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 6h16M4 12h16M4 18h16"/>
                </svg>

                <select id="school-select" name="school" class="filter-select">
                <option value="">All Schools</option>
                {% for s in schools %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
                </select>

                <svg class="dropdown-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>



        <div class="filter-dropdown">
            <div class="filter-date-wrapper" id="date-wrapper">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 8h18M8 4v4M16 4v4M5 8v12h14V8"/>
                </svg>

                <span id="date-display" class="date-display">Select date</span>

                <svg class="dropdown-caret" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 9l-7 7-7-7"/>
                </svg>

                <input type="date" id="date-input" class="date-input-hidden">
            </div>
        </div>

    </div>
</div>
 
<!-- ====================== MAIN CONTENT - REPORTS DASHBOARD ====================== -->

    <div class="dashboard-grid">

    <div class="report-card">
    <h2 class="report-card-title">Category Classification</h2>
    <p>Issue distribution by category type</p>

    <div class="chart-container">
        <canvas id="ticketCategoryChart"></canvas>

        <div class="chart-legend">
            {% for label, count in category_legend %}
                <div class="legend-item">
                <!-- <span class="dot"></span>{{ label }}  -->
                <span class="dot dot-{{ forloop.counter0 }}"></span>{{ label }}
                <span class="count">{{ count }}</span>
                </div>
            {% endfor %}
        
        </div>
    </div>
    </div>

    <div class="platform-card">
    <div>
        <h2 class="title">Platform Distribution</h2>
        <p class="subtitle">Tickets by platform source</p>
    </div>

    <div class="platform-content">
        <!-- Donut on the left -->
        <div class="donut-wrapper">
            <div class="donut" id="platform-donut"></div>
            <div class="donut-center-text">
                <div class="center-count" id="center-count-value">560</div>
                <div class="center-label">{{ total_tickets }}</div>
            </div>
        </div>

        <!-- List on the right -->
        <div class="platform-list">
            <div class="platform-item" data-segment="web">
                <div class="platform-left">
                    <div class="platform-icon web"><div class="icon-desktop"></div></div>
                    <div>
                        <div class="platform-text-main">Web</div>
                        <div class="platform-text-sub">Application</div>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="platform-count">{{ web_count }}</div>
                    <div class="platform-progress"><div class="platform-progress-bar web"></div></div>
                   
                </div>
            </div>

            <div class="platform-item" data-segment="mobile">
                <div class="platform-left">
                    <div class="platform-icon mobile"><div class="icon-mobile"></div></div>
                    <div>
                        <div class="platform-text-main">Mobile</div>
                        <div class="platform-text-sub">Application</div>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="platform-count">{{ mobile_count }}</div>
                    <div class="platform-progress"><div class="platform-progress-bar mobile"></div></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global chart instances so we can destroy them later
let categoryChart = null;
let donutAnimationTimeout = null;

// Elements
const schoolSelect = document.getElementById('school-select');
const centerCount = document.getElementById('center-count-value');
const centerLabel = document.querySelector('.donut-center-text .center-label');
const platformItems = document.querySelectorAll('.platform-item');
const donut = document.getElementById('platform-donut');

// Colors matching your current bar chart
const COLORS = ['#e74c3c', '#f39c12', '#16a085', '#3498db', '#8e44ad', '#1abc9c'];

// Fetch and update all charts
function updateReports(schoolId = '') {
    const url = schoolId 
        ? `/reports_data?school=${schoolId}` 
        : `/reports_data`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            // === Update Bar Chart ===
            const ctx = document.getElementById('ticketCategoryChart').getContext('2d');
            
            if (categoryChart) categoryChart.destroy();

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.category_labels,
                    datasets: [{
                        data: data.category_data,
                        backgroundColor: COLORS,
                        borderRadius: 6
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // === Update Legend Counts ===
            const legendContainer = document.querySelector('.chart-legend');
            legendContainer.innerHTML = '';
            data.category_legend.forEach(([label, count], i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <span class="dot dot-${i}"></span>${label}
                    <span class="count">${count}</span>
                `;
                legendContainer.appendChild(item);
            });

            // === Update Donut & Platform List ===
            const webPercent = data.total_tickets ? (data.web_count / data.total_tickets * 360).toFixed(1) : 0;
            const mobilePercent = 360 - webPercent;

            // Update donut gradient
            donut.style.background = `conic-gradient(
                #3498db 0deg ${webPercent}deg,
                #9b59b6 ${webPercent}deg 360deg
            )`;

            // Trigger re-animation
            donut.classList.remove('animate', 'final');
            clearTimeout(donutAnimationTimeout);
            donutAnimationTimeout = setTimeout(() => {
                donut.classList.add('animate');
                setTimeout(() => {
                    donut.classList.add('final');
                    donut.classList.remove('animate');
                }, 1200);
            }, 100);

            // Update counts in list
            document.querySelector('[data-segment="web"] .platform-count').textContent = data.web_count;
            document.querySelector('[data-segment="mobile"] .platform-count').textContent = data.mobile_count;

            // Update center text (default)
            centerCount.textContent = data.total_tickets;
            centerLabel.textContent = 'Total Tickets';

            // Update hover behavior with new counts
            platformItems.forEach(item => {
                const segment = item.dataset.segment;
                const count = segment === 'web' ? data.web_count : data.mobile_count;
                const name = segment === 'web' ? 'Web' : 'Mobile';

                item.onmouseenter = () => {
                    centerCount.textContent = count;
                    centerLabel.textContent = name + ' Tickets';
                };
                item.onmouseleave = () => {
                    centerCount.textContent = data.total_tickets;
                    centerLabel.textContent = 'Total Tickets';
                };
            });
        })
        .catch(err => console.error('Error loading reports data:', err));
}

// Initial load
updateReports();

// Listen to school change
schoolSelect.addEventListener('change', function() {
    updateReports(this.value || '');  // '' = All Schools
});
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Incidents Table</title>
<link rel="stylesheet" href="static/test.css">
</head>
<body>

  <div class="main-layout">
    <div class="sidebar">
     <div class="user-info">
       <div style="display:flex;align-items:center;gap:7px;">
         <span style="font-weight:700;">Ticket Creations</span>
       </div>
       <div style="margin-top:6px;font-size:13px;">
         <span>Welcome</span><br/>
         <span>{{ request.session.name|default:request.session.username }}</span>
         <span style="color:#e2fefd; font-weight:600;"></span>
       </div>
     </div>
     <nav class="sidebar-nav">
       <a href="#" class="nav-item">Overview</a>
       <a href="{% url 'dashboard' %}" class="nav-item active">Tickets</a>
       {% if request.session.role == 'admin' %}
       <li><a href="{% url 'user_management' %}" class="nav-item">User Management</a></li>
       <li><a href="{% url 'master_data' %}" class="nav-item">Master data</a></li>
       {% endif %}
       <a href="#" class="nav-item">Reports</a>
     </nav>
    </div>
    <div class="main-content">
      <div class="content-area">
                    {% if messages %}
            {% for message in messages %}
              <div style="background-color:#aef3ae; color:#077f17; padding:10px; border-radius:5px; margin-bottom:10px; font-weight:500;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        <!-- <h1 class="page-title">Tickets</h1> -->
        
        <div class="search-and-table-container">
            
            <header class="header">
            {% if request.session.role == 'admin' %}
            <form method="POST" action="{% url 'delete_tickets' %}" onsubmit="return confirm('Are you sure you want to delete the selected tickets?');">
        {% csrf_token %}
            <button type="submit" class="delete-ticket-btn">Delete</button>
            </form>
            {% endif %}
            <a href="{% url 'create' %}"><button type="button" class="add-ticket-btn">+ Add Ticket</button></a>
          </header>


         <fieldset class="page-title-fieldset">
          <legend>Tickets</legend>

        <div class="ticket-toolbar-modern">
        <div class="toolbar-controls">
            <label class="select-all-label">
            <input type="checkbox" id="selectAll"> All
            </label>
            <select id="columnSelect" class="toolbar-select">
                    <option>Number</option>
                    <option>Opened</option>
                    <option>Created by</option>
                    <option>Short description</option>
                    <option>Caller</option>
                    <option>School name</option>
                    <option>School code</option>
                    <option>Priority</option>
                    <option>State</option>
                    <option>Category</option>
                    <option>Assignment group</option>
                    <option>Assigned to</option>
                    <option>Updated</option>
                    <option>Updated by</option>
                    <option>Actions</option>
            </select>
            <input type="text" id="globalSearch" class="toolbar-search" placeholder="Search">

            <!-- Incidents Dropdown aligned right -->
            <div class="incidents-dropdown">
            <select id="incidentsDrop" class="toolbar-select">
                <option value="">Incidents</option>
                <option value="view">View</option>
                <option value="filters">Filters</option>
                <option value="groupby">Group By</option>
                <option value="show">Show</option>
                <option value="refresh">Refresh List</option>
                <option value="create">Create Favorite</option>
            </select>
            </div>
        </div>
        </div>



<table id="incidentsTable">
    <thead>
        <tr>
            <th><input type="checkbox" id="headerCheck"></th>
            <th data-col="number">Number <span class="col-menu">⋮</span></th>
            <th data-col="opened">Opened <span class="col-menu">⋮</span></th>
            <th data-col="created">Created by <span class="col-menu">⋮</span></th>
            <th data-col="desc">Short description <span class="col-menu">⋮</span></th>
            <th data-col="caller">Caller <span class="col-menu">⋮</span></th>
            <th data-col="school_name">School name <span class="col-menu">⋮</span></th>
            <th data-col="school_code">School code <span class="col-menu">⋮</span></th>
            <th data-col="priority">Priority <span class="col-menu">⋮</span></th>
            <th data-col="state">State <span class="col-menu">⋮</span></th>
            <th data-col="category">Category <span class="col-menu">⋮</span></th>
            <th data-col="assignGroup">Assignment group <span class="col-menu">⋮</span></th>
            <th data-col="assignedTo">Assigned to <span class="col-menu">⋮</span></th>
            <th data-col="updated">Updated <span class="col-menu">⋮</span></th>
            <th data-col="updatedBy">Updated by <span class="col-menu">⋮</span></th>
            <th data-col="actions">Actions</th>
        </tr>
        <!-- search row stays the same -->
        <tr class="search-row">
            <td></td>
            <td><input type="text" data-col="number" placeholder="Search"></td>
            <td><input type="text" data-col="opened" placeholder="Search"></td>
            <td><input type="text" data-col="created" placeholder="Search"></td>
            <td><input type="text" data-col="desc" placeholder="Search"></td>
            <td><input type="text" data-col="caller" placeholder="Search"></td>
            <td><input type="text" data-col="school_name" placeholder="Search"></td>
            <td><input type="text" data-col="school_code" placeholder="Search"></td>
            <td><input type="text" data-col="priority" placeholder="Search"></td>
            <td><input type="text" data-col="state" placeholder="Search"></td>
            <td><input type="text" data-col="category" placeholder="Search"></td>
            <td><input type="text" data-col="assignGroup" placeholder="Search"></td>
            <td><input type="text" data-col="assignedTo" placeholder="Search"></td>
            <td><input type="text" data-col="updated" placeholder="Search"></td>
            <td><input type="text" data-col="updatedBy" placeholder="Search"></td>
            <td></td>
        </tr>
    </thead>
    <tbody id="tableBody">
        {% for ticket in tickets %}
        <tr data-number="{{ ticket.number }}">
            <td><input type="checkbox" name="selected_tickets" value="{{ ticket.id }}" class="rowCheck"></td>
            <td><a href="{% url 'update' ticket_id=ticket.id %}">{{ ticket.number }}</a></td>
            <td>{{ ticket.created_at }}</td>
            <td>{{ ticket.created_by }}</td>
            <td>{{ ticket.short_description }}</td>
            <td>{{ ticket.caller }}</td>
            <td>{{ ticket.school_name }}</td>
            <td>{{ ticket.school_code }}</td>
            <td>{{ ticket.priority }}</td>
            <td>{{ ticket.state }}</td>
            <td>{{ ticket.category }}</td>
            <td>{{ ticket.assignment_group }}</td>
            <td>{{ ticket.assigned_to }}</td>
            <td>{{ ticket.updated_at }}</td>
            <td>{{ ticket.updated_by }}</td>
            <td class="actions">
                {% if ticket.school_email %}
                <a href="mailto:{{ ticket.school_email }}?subject=Regarding%20Ticket%20{{ ticket.number }}&body=Dear Sir/Madam,%0D%0A%0D%0A Regards,%0D%0AIT%20Support%20Team%0D%0AEdship%20Technologies">
                    <img src="https://img.icons8.com/ios-glyphs/18/new-post.png" alt="Email">
                </a>
                {% else %}
                <img src="https://img.icons8.com/ios-glyphs/18/new-post.png" alt="Email">
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Dropdown menu (hidden, will be cloned for each column) -->
<div id="columnMenuTemplate" style="display:none;">
    <div class="column-menu">
        <div class="menu-item" data-action="sort-asc">Sort (a to z)</div>
        <div class="menu-item" data-action="sort-desc">Sort (z to a)</div>
        <hr>
        <div class="menu-item" data-action="group">Group By</div>
        <div class="menu-item" data-action="ungroup">Ungroup</div>
        <hr>
        <div class="menu-item" data-action="taskboard">Show Visual Task Board</div>
        <div class="menu-item" data-action="bar">Bar Chart</div>
        <div class="menu-item" data-action="pie">Pie Chart</div>
    </div>
</div>
   <div class="pagination">
    <span>
        {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ page_obj.previous_page_number }}">previous</a>
        {% endif %}

        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
        {% endif %}
    </span>
</div>

</div>
      </div>
        </fieldset>
      </div>
    </div>
    </div>
    </div>


<script>
const table         = document.getElementById('incidentsTable');
const tbody         = document.getElementById('tableBody');
const rows          = () => tbody.querySelectorAll('tr:not(.group-header)');
const globalInp     = document.getElementById('globalSearch');
const colInputs     = table.querySelectorAll('.search-row input');
let currentGroupCol = null;


function filterTable() {
    const global = globalInp.value.trim().toLowerCase();
    const filters = {};
    colInputs.forEach(inp => {
        if (inp.value.trim()) filters[inp.dataset.col] = inp.value.trim().toLowerCase();
    });

    rows().forEach(row => {
        const cells = row.querySelectorAll('td');
        let show = true;

        if (global && !row.textContent.toLowerCase().includes(global)) show = false;

        for (const col in filters) {
            const th = [...table.querySelectorAll('th')].find(t => t.dataset.col === col);
            if (!th) continue;
            const idx = [...table.querySelectorAll('th')].indexOf(th);
            if (!cells[idx].textContent.toLowerCase().includes(filters[col])) show = false;
        }

        row.style.display = show ? '' : 'none';
    });
}
globalInp.addEventListener('input', filterTable);
colInputs.forEach(inp => inp.addEventListener('input', filterTable));


const selectAll = document.getElementById('selectAll');
const headerCheck = document.getElementById('headerCheck');
const rowChecks = table.querySelectorAll('.rowCheck');

function syncSelectAll() {
    const visible = [...rows()].filter(r => r.style.display !== 'none');
    const checked = visible.filter(r => r.querySelector('.rowCheck').checked);
    selectAll.indeterminate = checked.length > 0 && checked.length < visible.length;
    selectAll.checked = checked.length === visible.length && visible.length > 0;
}
selectAll.addEventListener('change', () => {
    const visible = [...rows()].filter(r => r.style.display !== 'none');
    visible.forEach(r => r.querySelector('.rowCheck').checked = selectAll.checked);
});
headerCheck.addEventListener('change', () => selectAll.checked = headerCheck.checked);
table.addEventListener('change', e => { if (e.target.classList.contains('rowCheck')) syncSelectAll(); });

// ---------- COLUMN MENU (three dots) - FIXED VERSION ----------
let activeMenu = null;

document.addEventListener('click', e => {
    const isMenuClick = e.target.classList.contains('col-menu');
    const isInsideMenu = e.target.closest && e.target.closest('.column-menu');

    // Close any open menu if clicked outside
    if (!isMenuClick && !isInsideMenu && activeMenu) {
        activeMenu.remove();
        activeMenu = null;
        return;
    }

    // Open menu if three dots clicked
    if (isMenuClick) {
        // Remove any previous menu
        if (activeMenu) activeMenu.remove();

        const template = document.getElementById('columnMenuTemplate').firstElementChild.cloneNode(true);
        const th = e.target.parentElement;
        const col = th.dataset.col;

        template.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.dataset.action;
                if (action === 'sort-asc') sortColumn(col, true);
                if (action === 'sort-desc') sortColumn(col, false);
                if (action === 'group') groupByColumn(col);
                if (action === 'ungroup') ungroup();
                if (action === 'taskboard') alert('Visual Task Board – not implemented');
                template.remove();
                activeMenu = null;
            });
        });

        th.style.position = 'relative';
        th.appendChild(template);

        // Position it properly below the header
        const rect = th.getBoundingClientRect();
        template.style.top = `${th.offsetHeight + 2}px`;
        template.style.left = `${rect.width - template.offsetWidth}px`; // align right
        template.style.transform = 'translateX(-8px)';

        activeMenu = template;
    }
});

// ---------- SORTING ----------
function sortColumn(colKey, ascending = true) {
    const ths = table.querySelectorAll('th');
    let idx = -1;
    ths.forEach((th, i) => { if (th.dataset.col === colKey) idx = i; });

    const arr = Array.from(rows());
    arr.sort((a, b) => {
        const aVal = a.children[idx].textContent.trim();
        const bVal = b.children[idx].textContent.trim();
        // simple date detection
        const aDate = Date.parse(aVal);
        const bDate = Date.parse(bVal);
        if (!isNaN(aDate) && !isNaN(bDate)) {
            return ascending ? aDate - bDate : bDate - aDate;
        }
        return ascending
            ? aVal.localeCompare(bVal)
            : bVal.localeCompare(aVal);
    });

    // remove groups first
    ungroup();
    arr.forEach(r => tbody.appendChild(r));
}

function groupByColumn(colKey) {
    ungroup();                     // clear any previous grouping
    currentGroupCol = colKey;

    const ths = table.querySelectorAll('th');
    let idx = -1;
    ths.forEach((th, i) => { if (th.dataset.col === colKey) idx = i; });

    const map = new Map();
    rows().forEach(row => {
        const key = row.children[idx].textContent.trim() || '(empty)';
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(row);
    });

    // Sort groups alphabetically
    const sortedKeys = [...map.keys()].sort((a, b) => a.localeCompare(b));

    sortedKeys.forEach(key => {
        const groupHeader = document.createElement('tr');
        groupHeader.className = 'group-header collapsed';  // <-- IMPORTANT: start collapsed
        groupHeader.dataset.groupKey = key;

        const cell = document.createElement('td');
        cell.colSpan = table.querySelectorAll('th').length;
        
        // Arrow + group name + count
        // cell.innerHTML = `<span class="group-arrow">▶</span> <strong>${key}</strong> (${map.get(key).length})`;
        cell.innerHTML = `<span class="group-arrow">▶</span> <span style="margin-left: 28px;">${key}</span> 
            <span style="color:#666; font-weight:normal; margin-left:8px;">(${map.get(key).length})</span>`;
        groupHeader.appendChild(cell);
        tbody.appendChild(groupHeader);

        // Add all tickets in this group (initially hidden)
        const groupRows = map.get(key);
        groupRows.forEach(r => {
            r.classList.add('group-member');
            r.style.display = 'none';           // <-- hide by default
            tbody.appendChild(r);
        });
    });

    // === Click handler for expand/collapse ===
    tbody.querySelectorAll('.group-header').forEach(header => {
        header.addEventListener('click', function () {
            this.classList.toggle('collapsed');

            const arrow = this.querySelector('.group-arrow');
            if (this.classList.contains('collapsed')) {
                arrow.textContent = '▶';
            } else {
                arrow.textContent = '▼';
            }

            let next = this.nextElementSibling;
            while (next && next.classList.contains('group-member')) {
                next.style.display = this.classList.contains('collapsed') ? 'none' : '';
                next = next.nextElementSibling;
            }
        });
    });
}


function ungroup() {
    document.querySelectorAll('.group-header').forEach(header => header.remove());
    document.querySelectorAll('tr').forEach(row => {
        if (!row.querySelector('th') && !row.classList.contains('search-row'))
        { 
            row.style.display = '';          
            row.classList.remove('group-member');
        }
    });

    currentGroupCol = null;
}

syncSelectAll();



</script>

</body>
</html>
